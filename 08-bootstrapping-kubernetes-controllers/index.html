
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.0">
    
    
      
        <title>8. Bootstrapping the Kubernetes Control Plane - Kubernetes the Hard way</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.33e2939f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#8-bootstrapping-the-kubernetes-control-plane" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Kubernetes the Hard way" class="md-header__button md-logo" aria-label="Kubernetes the Hard way" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kubernetes the Hard way
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              8. Bootstrapping the Kubernetes Control Plane
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/jizusun/kubernetes-the-hard-way/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Kubernetes the Hard way" class="md-nav__button md-logo" aria-label="Kubernetes the Hard way" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Kubernetes the Hard way
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/jizusun/kubernetes-the-hard-way/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to MkDocs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-prerequisites/" class="md-nav__link">
        1. Prerequisites
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-compute-resources/" class="md-nav__link">
        2. Provisioning Compute Resources
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-client-tools/" class="md-nav__link">
        3. Installing the Client Tools
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-certificate-authority/" class="md-nav__link">
        4. Provisioning a CA and Generating TLS Certificates
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-kubernetes-configuration-files/" class="md-nav__link">
        5. Generating Kubernetes Configuration Files for Authentication
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../06-data-encryption-keys/" class="md-nav__link">
        6. Generating the Data Encryption Config and Key
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../07-bootstrapping-etcd/" class="md-nav__link">
        7. Bootstrapping the etcd Cluster
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          8. Bootstrapping the Kubernetes Control Plane
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        8. Bootstrapping the Kubernetes Control Plane
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-commands-in-parallel-with-tmux" class="md-nav__link">
    Running commands in parallel with tmux
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#provision-the-kubernetes-control-plane" class="md-nav__link">
    Provision the Kubernetes Control Plane
  </a>
  
    <nav class="md-nav" aria-label="Provision the Kubernetes Control Plane">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#download-and-install-the-kubernetes-controller-binaries" class="md-nav__link">
    Download and Install the Kubernetes Controller Binaries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-kubernetes-api-server" class="md-nav__link">
    Configure the Kubernetes API Server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-kubernetes-controller-manager" class="md-nav__link">
    Configure the Kubernetes Controller Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-kubernetes-scheduler" class="md-nav__link">
    Configure the Kubernetes Scheduler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-the-controller-services" class="md-nav__link">
    Start the Controller Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verification" class="md-nav__link">
    Verification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-kubernetes-frontend-load-balancer" class="md-nav__link">
    The Kubernetes Frontend Load Balancer
  </a>
  
    <nav class="md-nav" aria-label="The Kubernetes Frontend Load Balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#provision-a-network-load-balancer" class="md-nav__link">
    Provision a Network Load Balancer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verification_1" class="md-nav__link">
    Verification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../09-bootstrapping-kubernetes-workers/" class="md-nav__link">
        9. Bootstrapping the Kubernetes Worker Nodes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../10-tls-bootstrapping-kubernetes-workers/" class="md-nav__link">
        10. TLS Bootstrapping Worker Nodes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../11-configuring-kubectl/" class="md-nav__link">
        11. Configuring kubectl for Remote Access
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../12-configure-pod-networking/" class="md-nav__link">
        12. Provisioning Pod Network
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../13-kube-apiserver-to-kubelet/" class="md-nav__link">
        13. Kubernetes API server to Kubelet
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../14-dns-addon/" class="md-nav__link">
        14. Deploying the DNS Cluster Add-on
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../15-smoke-test/" class="md-nav__link">
        15. Smoke Test
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../16-e2e-tests/" class="md-nav__link">
        16. Run End-to-End Tests
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../17-extra-dynamic-kubelet-configuration/" class="md-nav__link">
        17. Dynamic Kubelet Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../differences-to-original/" class="md-nav__link">
        Differences between original and this solution
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../verify-certificates/" class="md-nav__link">
        Verify Certificates in Master-1/2 & Worker-1
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-commands-in-parallel-with-tmux" class="md-nav__link">
    Running commands in parallel with tmux
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#provision-the-kubernetes-control-plane" class="md-nav__link">
    Provision the Kubernetes Control Plane
  </a>
  
    <nav class="md-nav" aria-label="Provision the Kubernetes Control Plane">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#download-and-install-the-kubernetes-controller-binaries" class="md-nav__link">
    Download and Install the Kubernetes Controller Binaries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-kubernetes-api-server" class="md-nav__link">
    Configure the Kubernetes API Server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-kubernetes-controller-manager" class="md-nav__link">
    Configure the Kubernetes Controller Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-kubernetes-scheduler" class="md-nav__link">
    Configure the Kubernetes Scheduler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-the-controller-services" class="md-nav__link">
    Start the Controller Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verification" class="md-nav__link">
    Verification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-kubernetes-frontend-load-balancer" class="md-nav__link">
    The Kubernetes Frontend Load Balancer
  </a>
  
    <nav class="md-nav" aria-label="The Kubernetes Frontend Load Balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#provision-a-network-load-balancer" class="md-nav__link">
    Provision a Network Load Balancer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verification_1" class="md-nav__link">
    Verification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jizusun/kubernetes-the-hard-way/edit/master/docs/08-bootstrapping-kubernetes-controllers.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="8-bootstrapping-the-kubernetes-control-plane">8. Bootstrapping the Kubernetes Control Plane</h1>
<p>In this lab you will bootstrap the Kubernetes control plane across 2 compute instances and configure it for high availability. You will also create an external load balancer that exposes the Kubernetes API Servers to remote clients. The following components will be installed on each node: Kubernetes API Server, Scheduler, and Controller Manager.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>The commands in this lab must be run on each controller instance: <code>master-1</code>, and <code>master-2</code>. Login to each controller instance using SSH Terminal. Example:</p>
<h3 id="running-commands-in-parallel-with-tmux">Running commands in parallel with tmux</h3>
<p><a href="https://github.com/tmux/tmux/wiki">tmux</a> can be used to run commands on multiple compute instances at the same time. See the <a href="../01-prerequisites/#running-commands-in-parallel-with-tmux">Running commands in parallel with tmux</a> section in the Prerequisites lab.</p>
<h2 id="provision-the-kubernetes-control-plane">Provision the Kubernetes Control Plane</h2>
<p>Create the Kubernetes configuration directory:</p>
<div class="highlight"><pre><span></span><code>sudo mkdir -p /etc/kubernetes/config
</code></pre></div>
<h3 id="download-and-install-the-kubernetes-controller-binaries">Download and Install the Kubernetes Controller Binaries</h3>
<p>Download the official Kubernetes release binaries:</p>
<div class="highlight"><pre><span></span><code>wget -q --show-progress --https-only --timestamping <span class="se">\</span>
  <span class="s2">&quot;https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-apiserver&quot;</span> <span class="se">\</span>
  <span class="s2">&quot;https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-controller-manager&quot;</span> <span class="se">\</span>
  <span class="s2">&quot;https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-scheduler&quot;</span> <span class="se">\</span>
  <span class="s2">&quot;https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kubectl&quot;</span>
</code></pre></div>
<p>Reference: https://kubernetes.io/docs/setup/release/#server-binaries</p>
<p>Install the Kubernetes binaries:</p>
<div class="highlight"><pre><span></span><code><span class="o">{</span>
  chmod +x kube-apiserver kube-controller-manager kube-scheduler kubectl
  sudo mv kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/
<span class="o">}</span>
</code></pre></div>
<h3 id="configure-the-kubernetes-api-server">Configure the Kubernetes API Server</h3>
<div class="highlight"><pre><span></span><code><span class="o">{</span>
  sudo mkdir -p /var/lib/kubernetes/

  sudo cp ca.crt ca.key kube-apiserver.crt kube-apiserver.key <span class="se">\</span>
    service-account.key service-account.crt <span class="se">\</span>
    etcd-server.key etcd-server.crt <span class="se">\</span>
    encryption-config.yaml /var/lib/kubernetes/
<span class="o">}</span>
</code></pre></div>
<p>The instance internal IP address will be used to advertise the API Server to members of the cluster. Retrieve the internal IP address for the current compute instance:</p>
<div class="highlight"><pre><span></span><code><span class="nv">INTERNAL_IP</span><span class="o">=</span><span class="k">$(</span>ip addr show enp0s8 <span class="p">|</span> grep <span class="s2">&quot;inet &quot;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> cut -d / -f <span class="m">1</span><span class="k">)</span>
</code></pre></div>
<p>Verify it is set</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="nv">$INTERNAL_IP</span>
</code></pre></div>
<p>Create the <code>kube-apiserver.service</code> systemd unit file:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | sudo tee /etc/systemd/system/kube-apiserver.service</span>
<span class="s">[Unit]</span>
<span class="s">Description=Kubernetes API Server</span>
<span class="s">Documentation=https://github.com/kubernetes/kubernetes</span>

<span class="s">[Service]</span>
<span class="s">ExecStart=/usr/local/bin/kube-apiserver \\</span>
<span class="s">  --advertise-address=${INTERNAL_IP} \\</span>
<span class="s">  --allow-privileged=true \\</span>
<span class="s">  --apiserver-count=2 \\</span>
<span class="s">  --audit-log-maxage=30 \\</span>
<span class="s">  --audit-log-maxbackup=3 \\</span>
<span class="s">  --audit-log-maxsize=100 \\</span>
<span class="s">  --audit-log-path=/var/log/audit.log \\</span>
<span class="s">  --authorization-mode=Node,RBAC \\</span>
<span class="s">  --bind-address=0.0.0.0 \\</span>
<span class="s">  --client-ca-file=/var/lib/kubernetes/ca.crt \\</span>
<span class="s">  --enable-admission-plugins=NodeRestriction,ServiceAccount \\</span>
<span class="s">  --enable-swagger-ui=true \\</span>
<span class="s">  --enable-bootstrap-token-auth=true \\</span>
<span class="s">  --etcd-cafile=/var/lib/kubernetes/ca.crt \\</span>
<span class="s">  --etcd-certfile=/var/lib/kubernetes/etcd-server.crt \\</span>
<span class="s">  --etcd-keyfile=/var/lib/kubernetes/etcd-server.key \\</span>
<span class="s">  --etcd-servers=https://192.168.5.11:2379,https://192.168.5.12:2379 \\</span>
<span class="s">  --event-ttl=1h \\</span>
<span class="s">  --encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \\</span>
<span class="s">  --kubelet-certificate-authority=/var/lib/kubernetes/ca.crt \\</span>
<span class="s">  --kubelet-client-certificate=/var/lib/kubernetes/kube-apiserver.crt \\</span>
<span class="s">  --kubelet-client-key=/var/lib/kubernetes/kube-apiserver.key \\</span>
<span class="s">  --kubelet-https=true \\</span>
<span class="s">  --runtime-config=api/all=true \\</span>
<span class="s">  --service-account-key-file=/var/lib/kubernetes/service-account.crt \\</span>
<span class="s">  --service-cluster-ip-range=10.96.0.0/24 \\</span>
<span class="s">  --service-node-port-range=30000-32767 \\</span>
<span class="s">  --tls-cert-file=/var/lib/kubernetes/kube-apiserver.crt \\</span>
<span class="s">  --tls-private-key-file=/var/lib/kubernetes/kube-apiserver.key \\</span>
<span class="s">  --v=2</span>
<span class="s">Restart=on-failure</span>
<span class="s">RestartSec=5</span>

<span class="s">[Install]</span>
<span class="s">WantedBy=multi-user.target</span>
<span class="s">EOF</span>
</code></pre></div>
<h3 id="configure-the-kubernetes-controller-manager">Configure the Kubernetes Controller Manager</h3>
<p>Copy the <code>kube-controller-manager</code> kubeconfig into place:</p>
<div class="highlight"><pre><span></span><code>sudo cp kube-controller-manager.kubeconfig /var/lib/kubernetes/
</code></pre></div>
<p>Create the <code>kube-controller-manager.service</code> systemd unit file:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | sudo tee /etc/systemd/system/kube-controller-manager.service</span>
<span class="s">[Unit]</span>
<span class="s">Description=Kubernetes Controller Manager</span>
<span class="s">Documentation=https://github.com/kubernetes/kubernetes</span>

<span class="s">[Service]</span>
<span class="s">ExecStart=/usr/local/bin/kube-controller-manager \\</span>
<span class="s">  --address=0.0.0.0 \\</span>
<span class="s">  --cluster-cidr=192.168.5.0/24 \\</span>
<span class="s">  --cluster-name=kubernetes \\</span>
<span class="s">  --cluster-signing-cert-file=/var/lib/kubernetes/ca.crt \\</span>
<span class="s">  --cluster-signing-key-file=/var/lib/kubernetes/ca.key \\</span>
<span class="s">  --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\</span>
<span class="s">  --leader-elect=true \\</span>
<span class="s">  --root-ca-file=/var/lib/kubernetes/ca.crt \\</span>
<span class="s">  --service-account-private-key-file=/var/lib/kubernetes/service-account.key \\</span>
<span class="s">  --service-cluster-ip-range=10.96.0.0/24 \\</span>
<span class="s">  --use-service-account-credentials=true \\</span>
<span class="s">  --v=2</span>
<span class="s">Restart=on-failure</span>
<span class="s">RestartSec=5</span>

<span class="s">[Install]</span>
<span class="s">WantedBy=multi-user.target</span>
<span class="s">EOF</span>
</code></pre></div>
<h3 id="configure-the-kubernetes-scheduler">Configure the Kubernetes Scheduler</h3>
<p>Copy the <code>kube-scheduler</code> kubeconfig into place:</p>
<div class="highlight"><pre><span></span><code>sudo cp kube-scheduler.kubeconfig /var/lib/kubernetes/
</code></pre></div>
<p>Create the <code>kube-scheduler.service</code> systemd unit file:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | sudo tee /etc/systemd/system/kube-scheduler.service</span>
<span class="s">[Unit]</span>
<span class="s">Description=Kubernetes Scheduler</span>
<span class="s">Documentation=https://github.com/kubernetes/kubernetes</span>

<span class="s">[Service]</span>
<span class="s">ExecStart=/usr/local/bin/kube-scheduler \\</span>
<span class="s">  --kubeconfig=/var/lib/kubernetes/kube-scheduler.kubeconfig \\</span>
<span class="s">  --address=127.0.0.1 \\</span>
<span class="s">  --leader-elect=true \\</span>
<span class="s">  --v=2</span>
<span class="s">Restart=on-failure</span>
<span class="s">RestartSec=5</span>

<span class="s">[Install]</span>
<span class="s">WantedBy=multi-user.target</span>
<span class="s">EOF</span>
</code></pre></div>
<h3 id="start-the-controller-services">Start the Controller Services</h3>
<div class="highlight"><pre><span></span><code><span class="o">{</span>
  sudo systemctl daemon-reload
  sudo systemctl <span class="nb">enable</span> kube-apiserver kube-controller-manager kube-scheduler
  sudo systemctl start kube-apiserver kube-controller-manager kube-scheduler
<span class="o">}</span>
</code></pre></div>
<blockquote>
<p>Allow up to 10 seconds for the Kubernetes API Server to fully initialize.</p>
</blockquote>
<h3 id="verification">Verification</h3>
<div class="highlight"><pre><span></span><code>kubectl get componentstatuses --kubeconfig admin.kubeconfig
</code></pre></div>
<div class="highlight"><pre><span></span><code>NAME                 STATUS    MESSAGE              ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-0               Healthy   <span class="o">{</span><span class="s2">&quot;health&quot;</span>: <span class="s2">&quot;true&quot;</span><span class="o">}</span>
etcd-1               Healthy   <span class="o">{</span><span class="s2">&quot;health&quot;</span>: <span class="s2">&quot;true&quot;</span><span class="o">}</span>
</code></pre></div>
<blockquote>
<p>Remember to run the above commands on each controller node: <code>master-1</code>, and <code>master-2</code>.</p>
</blockquote>
<h2 id="the-kubernetes-frontend-load-balancer">The Kubernetes Frontend Load Balancer</h2>
<p>In this section you will provision an external load balancer to front the Kubernetes API Servers. The <code>kubernetes-the-hard-way</code> static IP address will be attached to the resulting load balancer.</p>
<h3 id="provision-a-network-load-balancer">Provision a Network Load Balancer</h3>
<p>Login to <code>loadbalancer</code> instance using SSH Terminal.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Install HAProxy</span>
loadbalancer# sudo apt-get update <span class="o">&amp;&amp;</span> sudo apt-get install -y haproxy
</code></pre></div>
<div class="highlight"><pre><span></span><code>loadbalancer# cat <span class="s">&lt;&lt;EOF | sudo tee /etc/haproxy/haproxy.cfg </span>
<span class="s">frontend kubernetes</span>
<span class="s">    bind 192.168.5.30:6443</span>
<span class="s">    option tcplog</span>
<span class="s">    mode tcp</span>
<span class="s">    default_backend kubernetes-master-nodes</span>

<span class="s">backend kubernetes-master-nodes</span>
<span class="s">    mode tcp</span>
<span class="s">    balance roundrobin</span>
<span class="s">    option tcp-check</span>
<span class="s">    server master-1 192.168.5.11:6443 check fall 3 rise 2</span>
<span class="s">    server master-2 192.168.5.12:6443 check fall 3 rise 2</span>
<span class="s">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>loadbalancer# sudo service haproxy restart
</code></pre></div>
<h3 id="verification_1">Verification</h3>
<p>Make a HTTP request for the Kubernetes version info:</p>
<div class="highlight"><pre><span></span><code>curl  https://192.168.5.30:6443/version -k
</code></pre></div>
<blockquote>
<p>output</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="o">{</span>
  <span class="s2">&quot;major&quot;</span>: <span class="s2">&quot;1&quot;</span>,
  <span class="s2">&quot;minor&quot;</span>: <span class="s2">&quot;13&quot;</span>,
  <span class="s2">&quot;gitVersion&quot;</span>: <span class="s2">&quot;v1.13.0&quot;</span>,
  <span class="s2">&quot;gitCommit&quot;</span>: <span class="s2">&quot;ddf47ac13c1a9483ea035a79cd7c10005ff21a6d&quot;</span>,
  <span class="s2">&quot;gitTreeState&quot;</span>: <span class="s2">&quot;clean&quot;</span>,
  <span class="s2">&quot;buildDate&quot;</span>: <span class="s2">&quot;2018-12-03T20:56:12Z&quot;</span>,
  <span class="s2">&quot;goVersion&quot;</span>: <span class="s2">&quot;go1.11.2&quot;</span>,
  <span class="s2">&quot;compiler&quot;</span>: <span class="s2">&quot;gc&quot;</span>,
  <span class="s2">&quot;platform&quot;</span>: <span class="s2">&quot;linux/amd64&quot;</span>
<span class="o">}</span>
</code></pre></div>
<p>Next: <a href="../09-bootstrapping-kubernetes-workers/">Bootstrapping the Kubernetes Worker Nodes</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../07-bootstrapping-etcd/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              7. Bootstrapping the etcd Cluster
            </div>
          </div>
        </a>
      
      
        <a href="../09-bootstrapping-kubernetes-workers/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              9. Bootstrapping the Kubernetes Worker Nodes
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.d892486b.min.js"></script>
      
    
  </body>
</html>