
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.6">
    
    
      
        <title>10. TLS Bootstrapping Worker Nodes - Kubernetes the Hard way</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2c0c5eaf.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.7fa14f5b.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#10-tls-bootstrapping-worker-nodes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Kubernetes the Hard way" class="md-header__button md-logo" aria-label="Kubernetes the Hard way" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kubernetes the Hard way
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              10. TLS Bootstrapping Worker Nodes
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/jizusun/kubernetes-the-hard-way/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Kubernetes the Hard way" class="md-nav__button md-logo" aria-label="Kubernetes the Hard way" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Kubernetes the Hard way
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/jizusun/kubernetes-the-hard-way/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to MkDocs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-prerequisites/" class="md-nav__link">
        1. Prerequisites
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-compute-resources/" class="md-nav__link">
        2. Provisioning Compute Resources
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-client-tools/" class="md-nav__link">
        3. Installing the Client Tools
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-certificate-authority/" class="md-nav__link">
        4. Provisioning a CA and Generating TLS Certificates
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-kubernetes-configuration-files/" class="md-nav__link">
        5. Generating Kubernetes Configuration Files for Authentication
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../06-data-encryption-keys/" class="md-nav__link">
        6. Generating the Data Encryption Config and Key
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../07-bootstrapping-etcd/" class="md-nav__link">
        7. Bootstrapping the etcd Cluster
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../08-bootstrapping-kubernetes-controllers/" class="md-nav__link">
        8. Bootstrapping the Kubernetes Control Plane
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../09-bootstrapping-kubernetes-workers/" class="md-nav__link">
        9. Bootstrapping the Kubernetes Worker Nodes
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          10. TLS Bootstrapping Worker Nodes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        10. TLS Bootstrapping Worker Nodes
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-required-for-tls-bootstrapping" class="md-nav__link">
    What is required for TLS Bootstrapping
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-requisite" class="md-nav__link">
    Pre-Requisite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-configure-the-binaries-on-the-worker-node" class="md-nav__link">
    Step 1 Configure the Binaries on the Worker node
  </a>
  
    <nav class="md-nav" aria-label="Step 1 Configure the Binaries on the Worker node">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#download-and-install-worker-binaries" class="md-nav__link">
    Download and Install Worker Binaries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#move-the-ca-certificate" class="md-nav__link">
    Move the ca certificate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-create-the-boostrap-token-to-be-used-by-nodeskubelets-to-invoke-certificate-api" class="md-nav__link">
    Step 2 Create the Boostrap Token to be used by Nodes(Kubelets) to invoke Certificate API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-authorize-workerskubelets-to-create-csr" class="md-nav__link">
    Step 2 Authorize workers(kubelets) to create CSR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-authorize-workerskubelets-to-approve-csr" class="md-nav__link">
    Step 3 Authorize workers(kubelets) to approve CSR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-authorize-workerskubelets-to-auto-renew-certificates-on-expiration" class="md-nav__link">
    Step 3 Authorize workers(kubelets) to Auto Renew Certificates on expiration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-configure-kubelet-to-tls-bootstrap" class="md-nav__link">
    Step 4 Configure Kubelet to TLS Bootstrap
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-create-kubelet-config-file" class="md-nav__link">
    Step 5 Create Kubelet Config File
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-configure-kubelet-service" class="md-nav__link">
    Step 6 Configure Kubelet Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-configure-the-kubernetes-proxy" class="md-nav__link">
    Step 7 Configure the Kubernetes Proxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-start-the-worker-services" class="md-nav__link">
    Step 8 Start the Worker Services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-9-approve-server-csr" class="md-nav__link">
    Step 9 Approve Server CSR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verification" class="md-nav__link">
    Verification
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../11-configuring-kubectl/" class="md-nav__link">
        11. Configuring kubectl for Remote Access
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../12-configure-pod-networking/" class="md-nav__link">
        12. Provisioning Pod Network
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../13-kube-apiserver-to-kubelet/" class="md-nav__link">
        13. Kubernetes API server to Kubelet
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../14-dns-addon/" class="md-nav__link">
        14. Deploying the DNS Cluster Add-on
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../15-smoke-test/" class="md-nav__link">
        15. Smoke Test
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../16-e2e-tests/" class="md-nav__link">
        16. Run End-to-End Tests
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../17-extra-dynamic-kubelet-configuration/" class="md-nav__link">
        17. Dynamic Kubelet Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../differences-to-original/" class="md-nav__link">
        Differences between original and this solution
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../verify-certificates/" class="md-nav__link">
        Verify Certificates in Master-1/2 & Worker-1
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-required-for-tls-bootstrapping" class="md-nav__link">
    What is required for TLS Bootstrapping
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-requisite" class="md-nav__link">
    Pre-Requisite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-configure-the-binaries-on-the-worker-node" class="md-nav__link">
    Step 1 Configure the Binaries on the Worker node
  </a>
  
    <nav class="md-nav" aria-label="Step 1 Configure the Binaries on the Worker node">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#download-and-install-worker-binaries" class="md-nav__link">
    Download and Install Worker Binaries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#move-the-ca-certificate" class="md-nav__link">
    Move the ca certificate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-create-the-boostrap-token-to-be-used-by-nodeskubelets-to-invoke-certificate-api" class="md-nav__link">
    Step 2 Create the Boostrap Token to be used by Nodes(Kubelets) to invoke Certificate API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-authorize-workerskubelets-to-create-csr" class="md-nav__link">
    Step 2 Authorize workers(kubelets) to create CSR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-authorize-workerskubelets-to-approve-csr" class="md-nav__link">
    Step 3 Authorize workers(kubelets) to approve CSR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-authorize-workerskubelets-to-auto-renew-certificates-on-expiration" class="md-nav__link">
    Step 3 Authorize workers(kubelets) to Auto Renew Certificates on expiration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-configure-kubelet-to-tls-bootstrap" class="md-nav__link">
    Step 4 Configure Kubelet to TLS Bootstrap
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-create-kubelet-config-file" class="md-nav__link">
    Step 5 Create Kubelet Config File
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-configure-kubelet-service" class="md-nav__link">
    Step 6 Configure Kubelet Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-configure-the-kubernetes-proxy" class="md-nav__link">
    Step 7 Configure the Kubernetes Proxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-start-the-worker-services" class="md-nav__link">
    Step 8 Start the Worker Services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-9-approve-server-csr" class="md-nav__link">
    Step 9 Approve Server CSR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verification" class="md-nav__link">
    Verification
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jizusun/kubernetes-the-hard-way/edit/master/docs/10-tls-bootstrapping-kubernetes-workers.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="10-tls-bootstrapping-worker-nodes">10. TLS Bootstrapping Worker Nodes</h1>
<p>In the previous step we configured a worker node by</p>
<ul>
<li>Creating a set of key pairs for the worker node by ourself</li>
<li>Getting them signed by the CA by ourself</li>
<li>Creating a kube-config file using this certificate by ourself</li>
<li>Everytime the certificate expires we must follow the same process of updating the certificate by ourself</li>
</ul>
<p>This is not a practical approach when you have 1000s of nodes in the cluster, and nodes dynamically being added and removed from the cluster.  With TLS boostrapping:</p>
<ul>
<li>The Nodes can generate certificate key pairs by themselves</li>
<li>The Nodes can generate certificate signing request by themselves</li>
<li>The Nodes can submit the certificate signing request to the Kubernetes CA (Using the Certificates API)</li>
<li>The Nodes can retrieve the signed certificate from the Kubernetes CA</li>
<li>The Nodes can generate a kube-config file using this certificate by themselves</li>
<li>The Nodes can start and join the cluster by themselves</li>
<li>The Nodes can renew certificates when they expire by themselves</li>
</ul>
<p>So let's get started!</p>
<h2 id="what-is-required-for-tls-bootstrapping">What is required for TLS Bootstrapping</h2>
<p><strong>Certificates API:</strong> The Certificate API (as discussed in the lecture) provides a set of APIs on Kubernetes that can help us manage certificates (Create CSR, Get them signed by CA, Retrieve signed certificate etc). The worker nodes (kubelets) have the ability to use this API to get certificates signed by the Kubernetes CA.</p>
<h2 id="pre-requisite">Pre-Requisite</h2>
<p><strong>kube-apiserver</strong> - Ensure bootstrap token based authentication is enabled on the kube-apiserver.</p>
<p><code>--enable-bootstrap-token-auth=true</code></p>
<p><strong>kube-controller-manager</strong> - The certificate requests are signed by the kube-controller-manager ultimately. The kube-controller-manager requires the CA Certificate and Key to perform these operations.</p>
<div class="highlight"><pre><span></span><code>  --cluster-signing-cert-file<span class="o">=</span>/var/lib/kubernetes/ca.crt <span class="se">\\</span>
  --cluster-signing-key-file<span class="o">=</span>/var/lib/kubernetes/ca.key
</code></pre></div>
<blockquote>
<p>Note: We have already configured these in our setup in this course</p>
</blockquote>
<p>Copy the ca certificate to the worker node:</p>
<div class="highlight"><pre><span></span><code>scp ca.crt worker-2:~/
</code></pre></div>
<h2 id="step-1-configure-the-binaries-on-the-worker-node">Step 1 Configure the Binaries on the Worker node</h2>
<h3 id="download-and-install-worker-binaries">Download and Install Worker Binaries</h3>
<div class="highlight"><pre><span></span><code>wget -q --show-progress --https-only --timestamping <span class="se">\</span>
  https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kubectl <span class="se">\</span>
  https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-proxy <span class="se">\</span>
  https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kubelet
</code></pre></div>
<p>Reference: https://kubernetes.io/docs/setup/release/#node-binaries</p>
<p>Create the installation directories:</p>
<div class="highlight"><pre><span></span><code>sudo mkdir -p <span class="se">\</span>
  /etc/cni/net.d <span class="se">\</span>
  /opt/cni/bin <span class="se">\</span>
  /var/lib/kubelet <span class="se">\</span>
  /var/lib/kube-proxy <span class="se">\</span>
  /var/lib/kubernetes <span class="se">\</span>
  /var/run/kubernetes
</code></pre></div>
<p>Install the worker binaries:</p>
<div class="highlight"><pre><span></span><code><span class="o">{</span>
  chmod +x kubectl kube-proxy kubelet
  sudo mv kubectl kube-proxy kubelet /usr/local/bin/
<span class="o">}</span>
</code></pre></div>
<h3 id="move-the-ca-certificate">Move the ca certificate</h3>
<p><code>sudo mv ca.crt /var/lib/kubernetes/</code></p>
<h2 id="step-2-create-the-boostrap-token-to-be-used-by-nodeskubelets-to-invoke-certificate-api">Step 2 Create the Boostrap Token to be used by Nodes(Kubelets) to invoke Certificate API</h2>
<p>For the workers(kubelet) to access the Certificates API, they need to authenticate to the kubernetes api-server first. For this we create a <a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/">Bootstrap Token</a> to be used by the kubelet</p>
<p>Bootstrap Tokens take the form of a 6 character token id followed by 16 character token secret separated by a dot. Eg: abcdef.0123456789abcdef. More formally, they must match the regular expression <code>[a-z0-9]{6}\.[a-z0-9]{16}</code></p>
<p>Bootstrap Tokens are created as a secret in the kube-system namespace.</p>
<div class="highlight"><pre><span></span><code>cat &gt; bootstrap-token-07401b.yaml <span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Secret</span>
<span class="s">metadata:</span>
<span class="s">  # Name MUST be of form &quot;bootstrap-token-&lt;token id&gt;&quot;</span>
<span class="s">  name: bootstrap-token-07401b</span>
<span class="s">  namespace: kube-system</span>

<span class="s"># Type MUST be &#39;bootstrap.kubernetes.io/token&#39;</span>
<span class="s">type: bootstrap.kubernetes.io/token</span>
<span class="s">stringData:</span>
<span class="s">  # Human readable description. Optional.</span>
<span class="s">  description: &quot;The default bootstrap token generated by &#39;kubeadm init&#39;.&quot;</span>

<span class="s">  # Token ID and secret. Required.</span>
<span class="s">  token-id: 07401b</span>
<span class="s">  token-secret: f395accd246ae52d</span>

<span class="s">  # Expiration. Optional.</span>
<span class="s">  expiration: 2021-03-10T03:22:11Z</span>

<span class="s">  # Allowed usages.</span>
<span class="s">  usage-bootstrap-authentication: &quot;true&quot;</span>
<span class="s">  usage-bootstrap-signing: &quot;true&quot;</span>

<span class="s">  # Extra groups to authenticate the token as. Must start with &quot;system:bootstrappers:&quot;</span>
<span class="s">  auth-extra-groups: system:bootstrappers:worker</span>
<span class="s">EOF</span>


kubectl create -f bootstrap-token-07401b.yaml
</code></pre></div>
<p>Things to note:</p>
<ul>
<li><strong>expiration</strong> - make sure its set to a date in the future.</li>
<li><strong>auth-extra-groups</strong> - this is the group the worker nodes are part of. It must start with "system:bootstrappers:" This group does not exist already. This group is associated with this token.</li>
</ul>
<p>Once this is created the token to be used for authentication is <code>07401b.f395accd246ae52d</code></p>
<p>Reference: https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#bootstrap-token-secret-format</p>
<h2 id="step-2-authorize-workerskubelets-to-create-csr">Step 2 Authorize workers(kubelets) to create CSR</h2>
<p>Next we associate the group we created before to the system:node-bootstrapper ClusterRole. This ClusterRole gives the group enough permissions to bootstrap the kubelet</p>
<div class="highlight"><pre><span></span><code>kubectl create clusterrolebinding create-csrs-for-bootstrapping --clusterrole<span class="o">=</span>system:node-bootstrapper --group<span class="o">=</span>system:bootstrappers

--------------- OR ---------------

cat &gt; csrs-for-bootstrapping.yaml <span class="s">&lt;&lt;EOF</span>
<span class="s"># enable bootstrapping nodes to create CSR</span>
<span class="s">kind: ClusterRoleBinding</span>
<span class="s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="s">metadata:</span>
<span class="s">  name: create-csrs-for-bootstrapping</span>
<span class="s">subjects:</span>
<span class="s">- kind: Group</span>
<span class="s">  name: system:bootstrappers</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">roleRef:</span>
<span class="s">  kind: ClusterRole</span>
<span class="s">  name: system:node-bootstrapper</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">EOF</span>


kubectl create -f csrs-for-bootstrapping.yaml
</code></pre></div>
<p>Reference: </p>
<ul>
<li><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#authorize-kubelet-to-create-csr">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#authorize-kubelet-to-create-csr</a></li>
</ul>
<h2 id="step-3-authorize-workerskubelets-to-approve-csr">Step 3 Authorize workers(kubelets) to approve CSR</h2>
<div class="highlight"><pre><span></span><code>kubectl create clusterrolebinding auto-approve-csrs-for-group --clusterrole<span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:nodeclient --group<span class="o">=</span>system:bootstrappers

--------------- OR ---------------


cat &gt; auto-approve-csrs-for-group.yaml <span class="s">&lt;&lt;EOF</span>
<span class="s"># Approve all CSRs for the group &quot;system:bootstrappers&quot; </span>
<span class="s">kind: ClusterRoleBinding</span>
<span class="s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="s">metadata:</span>
<span class="s">  name: auto-approve-csrs-for-group</span>
<span class="s">subjects:</span>
<span class="s">- kind: Group</span>
<span class="s">  name: system:bootstrappers</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">roleRef:</span>
<span class="s">  kind: ClusterRole</span>
<span class="s">  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">EOF</span>


kubectl create -f auto-approve-csrs-for-group.yaml
</code></pre></div>
<p>Reference: </p>
<ul>
<li><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#approval">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#approval</a></li>
</ul>
<h2 id="step-3-authorize-workerskubelets-to-auto-renew-certificates-on-expiration">Step 3 Authorize workers(kubelets) to Auto Renew Certificates on expiration</h2>
<p>We now create the Cluster Role Binding required for the nodes to automatically renew the certificates on expiry. Note that we are NOT using the <strong>system:bootstrappers</strong> group here any more. Since by the renewal period, we believe the node would be bootstrapped and part of the cluster already. All nodes are part of the <strong>system:nodes</strong> group.</p>
<div class="highlight"><pre><span></span><code>kubectl create clusterrolebinding auto-approve-renewals-for-nodes --clusterrole<span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient --group<span class="o">=</span>system:nodes

--------------- OR ---------------

cat &gt; auto-approve-renewals-for-nodes.yaml <span class="s">&lt;&lt;EOF</span>
<span class="s"># Approve renewal CSRs for the group &quot;system:nodes&quot;</span>
<span class="s">kind: ClusterRoleBinding</span>
<span class="s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="s">metadata:</span>
<span class="s">  name: auto-approve-renewals-for-nodes</span>
<span class="s">subjects:</span>
<span class="s">- kind: Group</span>
<span class="s">  name: system:nodes</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">roleRef:</span>
<span class="s">  kind: ClusterRole</span>
<span class="s">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">EOF</span>


kubectl create -f auto-approve-renewals-for-nodes.yaml
</code></pre></div>
<p>Reference: </p>
<ul>
<li><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#approval">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#approval</a></li>
</ul>
<h2 id="step-4-configure-kubelet-to-tls-bootstrap">Step 4 Configure Kubelet to TLS Bootstrap</h2>
<p>It is now time to configure the second worker to TLS bootstrap using the token we generated</p>
<p>For worker-1 we started by creating a kubeconfig file with the TLS certificates that we manually generated.
Here, we don't have the certificates yet. So we cannot create a kubeconfig file. Instead we create a bootstrap-kubeconfig file with information about the token we created.</p>
<p>This is to be done on the <code>worker-2</code> node.</p>
<div class="highlight"><pre><span></span><code>sudo kubectl config --kubeconfig<span class="o">=</span>/var/lib/kubelet/bootstrap-kubeconfig set-cluster bootstrap --server<span class="o">=</span><span class="s1">&#39;https://192.168.5.30:6443&#39;</span> --certificate-authority<span class="o">=</span>/var/lib/kubernetes/ca.crt
sudo kubectl config --kubeconfig<span class="o">=</span>/var/lib/kubelet/bootstrap-kubeconfig set-credentials kubelet-bootstrap --token<span class="o">=</span>07401b.f395accd246ae52d
sudo kubectl config --kubeconfig<span class="o">=</span>/var/lib/kubelet/bootstrap-kubeconfig set-context bootstrap --user<span class="o">=</span>kubelet-bootstrap --cluster<span class="o">=</span>bootstrap
sudo kubectl config --kubeconfig<span class="o">=</span>/var/lib/kubelet/bootstrap-kubeconfig use-context bootstrap
</code></pre></div>
<p>Or</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | sudo tee /var/lib/kubelet/bootstrap-kubeconfig</span>
<span class="s">apiVersion: v1</span>
<span class="s">clusters:</span>
<span class="s">- cluster:</span>
<span class="s">    certificate-authority: /var/lib/kubernetes/ca.crt</span>
<span class="s">    server: https://192.168.5.30:6443</span>
<span class="s">  name: bootstrap</span>
<span class="s">contexts:</span>
<span class="s">- context:</span>
<span class="s">    cluster: bootstrap</span>
<span class="s">    user: kubelet-bootstrap</span>
<span class="s">  name: bootstrap</span>
<span class="s">current-context: bootstrap</span>
<span class="s">kind: Config</span>
<span class="s">preferences: {}</span>
<span class="s">users:</span>
<span class="s">- name: kubelet-bootstrap</span>
<span class="s">  user:</span>
<span class="s">    token: 07401b.f395accd246ae52d</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Reference: </p>
<ul>
<li><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#kubelet-configuration">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#kubelet-configuration</a></li>
</ul>
<h2 id="step-5-create-kubelet-config-file">Step 5 Create Kubelet Config File</h2>
<p>Create the <code>kubelet-config.yaml</code> configuration file:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml</span>
<span class="s">kind: KubeletConfiguration</span>
<span class="s">apiVersion: kubelet.config.k8s.io/v1beta1</span>
<span class="s">authentication:</span>
<span class="s">  anonymous:</span>
<span class="s">    enabled: false</span>
<span class="s">  webhook:</span>
<span class="s">    enabled: true</span>
<span class="s">  x509:</span>
<span class="s">    clientCAFile: &quot;/var/lib/kubernetes/ca.crt&quot;</span>
<span class="s">authorization:</span>
<span class="s">  mode: Webhook</span>
<span class="s">clusterDomain: &quot;cluster.local&quot;</span>
<span class="s">clusterDNS:</span>
<span class="s">  - &quot;10.96.0.10&quot;</span>
<span class="s">resolvConf: &quot;/run/systemd/resolve/resolv.conf&quot;</span>
<span class="s">runtimeRequestTimeout: &quot;15m&quot;</span>
<span class="s">EOF</span>
</code></pre></div>
<blockquote>
<p>Note: We are not specifying the certificate details - tlsCertFile and tlsPrivateKeyFile - in this file</p>
</blockquote>
<h2 id="step-6-configure-kubelet-service">Step 6 Configure Kubelet Service</h2>
<p>Create the <code>kubelet.service</code> systemd unit file:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service</span>
<span class="s">[Unit]</span>
<span class="s">Description=Kubernetes Kubelet</span>
<span class="s">Documentation=https://github.com/kubernetes/kubernetes</span>
<span class="s">After=docker.service</span>
<span class="s">Requires=docker.service</span>

<span class="s">[Service]</span>
<span class="s">ExecStart=/usr/local/bin/kubelet \\</span>
<span class="s">  --bootstrap-kubeconfig=&quot;/var/lib/kubelet/bootstrap-kubeconfig&quot; \\</span>
<span class="s">  --config=/var/lib/kubelet/kubelet-config.yaml \\</span>
<span class="s">  --image-pull-progress-deadline=2m \\</span>
<span class="s">  --kubeconfig=/var/lib/kubelet/kubeconfig \\</span>
<span class="s">  --cert-dir=/var/lib/kubelet/pki/ \\</span>
<span class="s">  --rotate-certificates=true \\</span>
<span class="s">  --rotate-server-certificates=true \\</span>
<span class="s">  --network-plugin=cni \\</span>
<span class="s">  --register-node=true \\</span>
<span class="s">  --v=2</span>
<span class="s">Restart=on-failure</span>
<span class="s">RestartSec=5</span>

<span class="s">[Install]</span>
<span class="s">WantedBy=multi-user.target</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Things to note here:</p>
<ul>
<li><strong>bootstrap-kubeconfig</strong>: Location of the bootstrap-kubeconfig file.</li>
<li><strong>cert-dir</strong>: The directory where the generated certificates are stored.</li>
<li><strong>rotate-certificates</strong>: Rotates client certificates when they expire.</li>
<li><strong>rotate-server-certificates</strong>: Requests for server certificates on bootstrap and rotates them when they expire.</li>
</ul>
<h2 id="step-7-configure-the-kubernetes-proxy">Step 7 Configure the Kubernetes Proxy</h2>
<p>In one of the previous steps we created the <code>kube-proxy.kubeconfig</code> file. Check <a href="../05-kubernetes-configuration-files/">here</a> if you missed it.</p>
<div class="highlight"><pre><span></span><code>sudo mv kube-proxy.kubeconfig /var/lib/kube-proxy/kubeconfig
</code></pre></div>
<p>Create the <code>kube-proxy-config.yaml</code> configuration file:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml</span>
<span class="s">kind: KubeProxyConfiguration</span>
<span class="s">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span>
<span class="s">clientConnection:</span>
<span class="s">  kubeconfig: &quot;/var/lib/kube-proxy/kubeconfig&quot;</span>
<span class="s">mode: &quot;iptables&quot;</span>
<span class="s">clusterCIDR: &quot;192.168.5.0/24&quot;</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Create the <code>kube-proxy.service</code> systemd unit file:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | sudo tee /etc/systemd/system/kube-proxy.service</span>
<span class="s">[Unit]</span>
<span class="s">Description=Kubernetes Kube Proxy</span>
<span class="s">Documentation=https://github.com/kubernetes/kubernetes</span>

<span class="s">[Service]</span>
<span class="s">ExecStart=/usr/local/bin/kube-proxy \\</span>
<span class="s">  --config=/var/lib/kube-proxy/kube-proxy-config.yaml</span>
<span class="s">Restart=on-failure</span>
<span class="s">RestartSec=5</span>

<span class="s">[Install]</span>
<span class="s">WantedBy=multi-user.target</span>
<span class="s">EOF</span>
</code></pre></div>
<h2 id="step-8-start-the-worker-services">Step 8 Start the Worker Services</h2>
<div class="highlight"><pre><span></span><code><span class="o">{</span>
  sudo systemctl daemon-reload
  sudo systemctl <span class="nb">enable</span> kubelet kube-proxy
  sudo systemctl start kubelet kube-proxy
<span class="o">}</span>
</code></pre></div>
<blockquote>
<p>Remember to run the above commands on worker node: <code>worker-2</code></p>
</blockquote>
<h2 id="step-9-approve-server-csr">Step 9 Approve Server CSR</h2>
<p><code>kubectl get csr</code></p>
<div class="highlight"><pre><span></span><code>NAME                                                   AGE   REQUESTOR                 CONDITION
csr-95bv6                                              20s   system:node:worker-2      Pending
</code></pre></div>
<p>Approve</p>
<p><code>kubectl certificate approve csr-95bv6</code></p>
<p>Reference: </p>
<ul>
<li><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#kubectl-approval">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#kubectl-approval</a></li>
</ul>
<h2 id="verification">Verification</h2>
<p>List the registered Kubernetes nodes from the master node:</p>
<div class="highlight"><pre><span></span><code>master-1$ kubectl get nodes --kubeconfig admin.kubeconfig
</code></pre></div>
<blockquote>
<p>output</p>
</blockquote>
<p><div class="highlight"><pre><span></span><code>NAME       STATUS   ROLES    AGE   VERSION
worker-1   NotReady   &lt;none&gt;   93s   v1.13.0
worker-2   NotReady   &lt;none&gt;   93s   v1.13.0
</code></pre></div>
Note: It is OK for the worker node to be in a NotReady state. That is because we haven't configured Networking yet.</p>
<p>Next: <a href="../11-configuring-kubectl/">Configuring Kubectl</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../09-bootstrapping-kubernetes-workers/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              9. Bootstrapping the Kubernetes Worker Nodes
            </div>
          </div>
        </a>
      
      
        <a href="../11-configuring-kubectl/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              11. Configuring kubectl for Remote Access
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.a1c7c35e.min.js"></script>
      
    
  </body>
</html>