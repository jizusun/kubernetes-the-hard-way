
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.5">
    
    
      
        <title>4. Provisioning a CA and Generating TLS Certificates - Kubernetes the Hard way</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.77f3fd56.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.7fa14f5b.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#4-provisioning-a-ca-and-generating-tls-certificates" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Kubernetes the Hard way" class="md-header__button md-logo" aria-label="Kubernetes the Hard way">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kubernetes the Hard way
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4. Provisioning a CA and Generating TLS Certificates
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/jizusun/kubernetes-the-hard-way/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Kubernetes the Hard way" class="md-nav__button md-logo" aria-label="Kubernetes the Hard way">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Kubernetes the Hard way
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/jizusun/kubernetes-the-hard-way/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to MkDocs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-prerequisites/" class="md-nav__link">
        1. Prerequisites
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-compute-resources/" class="md-nav__link">
        2. Provisioning Compute Resources
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-client-tools/" class="md-nav__link">
        3. Installing the Client Tools
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          4. Provisioning a CA and Generating TLS Certificates
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        4. Provisioning a CA and Generating TLS Certificates
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#where-to-do-these" class="md-nav__link">
    Where to do these?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-authority" class="md-nav__link">
    Certificate Authority
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-and-server-certificates" class="md-nav__link">
    Client and Server Certificates
  </a>
  
    <nav class="md-nav" aria-label="Client and Server Certificates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-admin-client-certificate" class="md-nav__link">
    The Admin Client Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-kubelet-client-certificates" class="md-nav__link">
    The Kubelet Client Certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-controller-manager-client-certificate" class="md-nav__link">
    The Controller Manager Client Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-kube-proxy-client-certificate" class="md-nav__link">
    The Kube Proxy Client Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-scheduler-client-certificate" class="md-nav__link">
    The Scheduler Client Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-kubernetes-api-server-certificate" class="md-nav__link">
    The Kubernetes API Server Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-etcd-server-certificate" class="md-nav__link">
    The ETCD Server Certificate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-service-account-key-pair" class="md-nav__link">
    The Service Account Key Pair
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distribute-the-certificates" class="md-nav__link">
    Distribute the Certificates
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-kubernetes-configuration-files/" class="md-nav__link">
        5. Generating Kubernetes Configuration Files for Authentication
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../06-data-encryption-keys/" class="md-nav__link">
        6. Generating the Data Encryption Config and Key
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../07-bootstrapping-etcd/" class="md-nav__link">
        7. Bootstrapping the etcd Cluster
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../08-bootstrapping-kubernetes-controllers/" class="md-nav__link">
        8. Bootstrapping the Kubernetes Control Plane
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../09-bootstrapping-kubernetes-workers/" class="md-nav__link">
        9. Bootstrapping the Kubernetes Worker Nodes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../10-tls-bootstrapping-kubernetes-workers/" class="md-nav__link">
        10. TLS Bootstrapping Worker Nodes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../11-configuring-kubectl/" class="md-nav__link">
        11. Configuring kubectl for Remote Access
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../12-configure-pod-networking/" class="md-nav__link">
        12. Provisioning Pod Network
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../13-kube-apiserver-to-kubelet/" class="md-nav__link">
        13. Kubernetes API server to Kubelet
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../14-dns-addon/" class="md-nav__link">
        14. Deploying the DNS Cluster Add-on
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../15-smoke-test/" class="md-nav__link">
        15. Smoke Test
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../16-e2e-tests/" class="md-nav__link">
        16. Run End-to-End Tests
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../17-extra-dynamic-kubelet-configuration/" class="md-nav__link">
        17. Dynamic Kubelet Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../differences-to-original/" class="md-nav__link">
        Differences between original and this solution
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../verify-certificates/" class="md-nav__link">
        Verify Certificates in Master-1/2 & Worker-1
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#where-to-do-these" class="md-nav__link">
    Where to do these?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-authority" class="md-nav__link">
    Certificate Authority
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-and-server-certificates" class="md-nav__link">
    Client and Server Certificates
  </a>
  
    <nav class="md-nav" aria-label="Client and Server Certificates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-admin-client-certificate" class="md-nav__link">
    The Admin Client Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-kubelet-client-certificates" class="md-nav__link">
    The Kubelet Client Certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-controller-manager-client-certificate" class="md-nav__link">
    The Controller Manager Client Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-kube-proxy-client-certificate" class="md-nav__link">
    The Kube Proxy Client Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-scheduler-client-certificate" class="md-nav__link">
    The Scheduler Client Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-kubernetes-api-server-certificate" class="md-nav__link">
    The Kubernetes API Server Certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-etcd-server-certificate" class="md-nav__link">
    The ETCD Server Certificate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-service-account-key-pair" class="md-nav__link">
    The Service Account Key Pair
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distribute-the-certificates" class="md-nav__link">
    Distribute the Certificates
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jizusun/kubernetes-the-hard-way/edit/master/docs/04-certificate-authority.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="4-provisioning-a-ca-and-generating-tls-certificates">4. Provisioning a CA and Generating TLS Certificates</h1>
<p>In this lab you will provision a <a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">PKI Infrastructure</a> using the popular openssl tool, then use it to bootstrap a Certificate Authority, and generate TLS certificates for the following components: etcd, kube-apiserver, kube-controller-manager, kube-scheduler, kubelet, and kube-proxy.</p>
<h2 id="where-to-do-these">Where to do these?</h2>
<p>You can do these on any machine with <code>openssl</code> on it. But you should be able to copy the generated files to the provisioned VMs. Or just do these from one of the master nodes.</p>
<p>In our case we do it on the master-1 node, as we have set it up to be the administrative client.</p>
<h2 id="certificate-authority">Certificate Authority</h2>
<p>In this section you will provision a Certificate Authority that can be used to generate additional TLS certificates.</p>
<p>Create a CA certificate, then generate a Certificate Signing Request and use it to create a private key:</p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># Create private key for CA</span>
openssl genrsa -out ca.key <span class="m">2048</span>

<span class="c1"># Comment line starting with RANDFILE in /etc/ssl/openssl.cnf definition to avoid permission issues</span>
sudo sed -i <span class="s1">&#39;0,/RANDFILE/{s/RANDFILE/\#&amp;/}&#39;</span> /etc/ssl/openssl.cnf

<span class="c1"># Create CSR using the private key</span>
openssl req -new -key ca.key -subj <span class="s2">&quot;/CN=KUBERNETES-CA&quot;</span> -out ca.csr

<span class="c1"># Self sign the csr using its own private key</span>
openssl x509 -req -in ca.csr -signkey ca.key -CAcreateserial  -out ca.crt -days <span class="m">1000</span>
</code></pre></div>
Results:</p>
<div class="highlight"><pre><span></span><code>ca.crt
ca.key
</code></pre></div>
<p>Reference : https://kubernetes.io/docs/concepts/cluster-administration/certificates/#openssl</p>
<p>The ca.crt is the Kubernetes Certificate Authority certificate and ca.key is the Kubernetes Certificate Authority private key.
You will use the ca.crt file in many places, so it will be copied to many places.
The ca.key is used by the CA for signing certificates. And it should be securely stored. In this case our master node(s) is our CA server as well, so we will store it on master node(s). There is not need to copy this file to elsewhere.</p>
<h2 id="client-and-server-certificates">Client and Server Certificates</h2>
<p>In this section you will generate client and server certificates for each Kubernetes component and a client certificate for the Kubernetes <code>admin</code> user.</p>
<h3 id="the-admin-client-certificate">The Admin Client Certificate</h3>
<p>Generate the <code>admin</code> client certificate and private key:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Generate private key for admin user</span>
openssl genrsa -out admin.key <span class="m">2048</span>

<span class="c1"># Generate CSR for admin user. Note the OU.</span>
openssl req -new -key admin.key -subj <span class="s2">&quot;/CN=admin/O=system:masters&quot;</span> -out admin.csr

<span class="c1"># Sign certificate for admin user using CA servers private key</span>
openssl x509 -req -in admin.csr -CA ca.crt -CAkey ca.key -CAcreateserial  -out admin.crt -days <span class="m">1000</span>
</code></pre></div>
<p>Note that the admin user is part of the <strong>system:masters</strong> group. This is how we are able to perform any administrative operations on Kubernetes cluster using kubectl utility.</p>
<p>Results:</p>
<div class="highlight"><pre><span></span><code>admin.key
admin.crt
</code></pre></div>
<p>The admin.crt and admin.key file gives you administrative access. We will configure these to be used with the kubectl tool to perform administrative functions on kubernetes.</p>
<h3 id="the-kubelet-client-certificates">The Kubelet Client Certificates</h3>
<p>We are going to skip certificate configuration for Worker Nodes for now. We will deal with them when we configure the workers.
For now let's just focus on the control plane components.</p>
<h3 id="the-controller-manager-client-certificate">The Controller Manager Client Certificate</h3>
<p>Generate the <code>kube-controller-manager</code> client certificate and private key:</p>
<div class="highlight"><pre><span></span><code>openssl genrsa -out kube-controller-manager.key <span class="m">2048</span>
openssl req -new -key kube-controller-manager.key -subj <span class="s2">&quot;/CN=system:kube-controller-manager&quot;</span> -out kube-controller-manager.csr
openssl x509 -req -in kube-controller-manager.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out kube-controller-manager.crt -days <span class="m">1000</span>
</code></pre></div>
<p>Results:</p>
<div class="highlight"><pre><span></span><code>kube-controller-manager.key
kube-controller-manager.crt
</code></pre></div>
<h3 id="the-kube-proxy-client-certificate">The Kube Proxy Client Certificate</h3>
<p>Generate the <code>kube-proxy</code> client certificate and private key:</p>
<div class="highlight"><pre><span></span><code>openssl genrsa -out kube-proxy.key <span class="m">2048</span>
openssl req -new -key kube-proxy.key -subj <span class="s2">&quot;/CN=system:kube-proxy&quot;</span> -out kube-proxy.csr
openssl x509 -req -in kube-proxy.csr -CA ca.crt -CAkey ca.key -CAcreateserial  -out kube-proxy.crt -days <span class="m">1000</span>
</code></pre></div>
<p>Results:</p>
<div class="highlight"><pre><span></span><code>kube-proxy.key
kube-proxy.crt
</code></pre></div>
<h3 id="the-scheduler-client-certificate">The Scheduler Client Certificate</h3>
<p>Generate the <code>kube-scheduler</code> client certificate and private key:</p>
<div class="highlight"><pre><span></span><code>openssl genrsa -out kube-scheduler.key <span class="m">2048</span>
openssl req -new -key kube-scheduler.key -subj <span class="s2">&quot;/CN=system:kube-scheduler&quot;</span> -out kube-scheduler.csr
openssl x509 -req -in kube-scheduler.csr -CA ca.crt -CAkey ca.key -CAcreateserial  -out kube-scheduler.crt -days <span class="m">1000</span>
</code></pre></div>
<p>Results:</p>
<div class="highlight"><pre><span></span><code>kube-scheduler.key
kube-scheduler.crt
</code></pre></div>
<h3 id="the-kubernetes-api-server-certificate">The Kubernetes API Server Certificate</h3>
<p>The kube-apiserver certificate requires all names that various components may reach it to be part of the alternate names. These include the different DNS names, and IP addresses such as the master servers IP address, the load balancers IP address, the kube-api service IP address etc.</p>
<p>The <code>openssl</code> command cannot take alternate names as command line parameter. So we must create a <code>conf</code> file for it:</p>
<div class="highlight"><pre><span></span><code>cat &gt; openssl.cnf <span class="s">&lt;&lt;EOF</span>
<span class="s">[req]</span>
<span class="s">req_extensions = v3_req</span>
<span class="s">distinguished_name = req_distinguished_name</span>
<span class="s">[req_distinguished_name]</span>
<span class="s">[ v3_req ]</span>
<span class="s">basicConstraints = CA:FALSE</span>
<span class="s">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span>
<span class="s">subjectAltName = @alt_names</span>
<span class="s">[alt_names]</span>
<span class="s">DNS.1 = kubernetes</span>
<span class="s">DNS.2 = kubernetes.default</span>
<span class="s">DNS.3 = kubernetes.default.svc</span>
<span class="s">DNS.4 = kubernetes.default.svc.cluster.local</span>
<span class="s">IP.1 = 10.96.0.1</span>
<span class="s">IP.2 = 192.168.5.11</span>
<span class="s">IP.3 = 192.168.5.12</span>
<span class="s">IP.4 = 192.168.5.30</span>
<span class="s">IP.5 = 127.0.0.1</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Generates certs for kube-apiserver</p>
<div class="highlight"><pre><span></span><code>openssl genrsa -out kube-apiserver.key <span class="m">2048</span>
openssl req -new -key kube-apiserver.key -subj <span class="s2">&quot;/CN=kube-apiserver&quot;</span> -out kube-apiserver.csr -config openssl.cnf
openssl x509 -req -in kube-apiserver.csr -CA ca.crt -CAkey ca.key -CAcreateserial  -out kube-apiserver.crt -extensions v3_req -extfile openssl.cnf -days <span class="m">1000</span>
</code></pre></div>
<p>Results:</p>
<div class="highlight"><pre><span></span><code>kube-apiserver.crt
kube-apiserver.key
</code></pre></div>
<h3 id="the-etcd-server-certificate">The ETCD Server Certificate</h3>
<p>Similarly ETCD server certificate must have addresses of all the servers part of the ETCD cluster</p>
<p>The <code>openssl</code> command cannot take alternate names as command line parameter. So we must create a <code>conf</code> file for it:</p>
<div class="highlight"><pre><span></span><code>cat &gt; openssl-etcd.cnf <span class="s">&lt;&lt;EOF</span>
<span class="s">[req]</span>
<span class="s">req_extensions = v3_req</span>
<span class="s">distinguished_name = req_distinguished_name</span>
<span class="s">[req_distinguished_name]</span>
<span class="s">[ v3_req ]</span>
<span class="s">basicConstraints = CA:FALSE</span>
<span class="s">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span>
<span class="s">subjectAltName = @alt_names</span>
<span class="s">[alt_names]</span>
<span class="s">IP.1 = 192.168.5.11</span>
<span class="s">IP.2 = 192.168.5.12</span>
<span class="s">IP.3 = 127.0.0.1</span>
<span class="s">EOF</span>
</code></pre></div>
<p>Generates certs for ETCD</p>
<div class="highlight"><pre><span></span><code>openssl genrsa -out etcd-server.key <span class="m">2048</span>
openssl req -new -key etcd-server.key -subj <span class="s2">&quot;/CN=etcd-server&quot;</span> -out etcd-server.csr -config openssl-etcd.cnf
openssl x509 -req -in etcd-server.csr -CA ca.crt -CAkey ca.key -CAcreateserial  -out etcd-server.crt -extensions v3_req -extfile openssl-etcd.cnf -days <span class="m">1000</span>
</code></pre></div>
<p>Results:</p>
<div class="highlight"><pre><span></span><code>etcd-server.key
etcd-server.crt
</code></pre></div>
<h2 id="the-service-account-key-pair">The Service Account Key Pair</h2>
<p>The Kubernetes Controller Manager leverages a key pair to generate and sign service account tokens as describe in the <a href="https://kubernetes.io/docs/admin/service-accounts-admin/">managing service accounts</a> documentation.</p>
<p>Generate the <code>service-account</code> certificate and private key:</p>
<div class="highlight"><pre><span></span><code>openssl genrsa -out service-account.key <span class="m">2048</span>
openssl req -new -key service-account.key -subj <span class="s2">&quot;/CN=service-accounts&quot;</span> -out service-account.csr
openssl x509 -req -in service-account.csr -CA ca.crt -CAkey ca.key -CAcreateserial  -out service-account.crt -days <span class="m">1000</span>
</code></pre></div>
<p>Results:</p>
<div class="highlight"><pre><span></span><code>service-account.key
service-account.crt
</code></pre></div>
<h2 id="distribute-the-certificates">Distribute the Certificates</h2>
<p>Copy the appropriate certificates and private keys to each controller instance:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> instance <span class="k">in</span> master-1 master-2<span class="p">;</span> <span class="k">do</span>
  scp ca.crt ca.key kube-apiserver.key kube-apiserver.crt <span class="se">\</span>
    service-account.key service-account.crt <span class="se">\</span>
    etcd-server.key etcd-server.crt <span class="se">\</span>
    <span class="si">${</span><span class="nv">instance</span><span class="si">}</span>:~/
<span class="k">done</span>
</code></pre></div>
<blockquote>
<p>The <code>kube-proxy</code>, <code>kube-controller-manager</code>, <code>kube-scheduler</code>, and <code>kubelet</code> client certificates will be used to generate client authentication configuration files in the next lab. These certificates will be embedded into the client authentication configuration files. We will then copy those configuration files to the other master nodes.</p>
</blockquote>
<p>Next: <a href="../05-kubernetes-configuration-files/">Generating Kubernetes Configuration Files for Authentication</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../03-client-tools/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              3. Installing the Client Tools
            </div>
          </div>
        </a>
      
      
        <a href="../05-kubernetes-configuration-files/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              5. Generating Kubernetes Configuration Files for Authentication
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.5cf3e710.min.js"></script>
      
    
  </body>
</html>